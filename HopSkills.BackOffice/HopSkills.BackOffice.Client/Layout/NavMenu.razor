@using System.Security.Claims
@implements IDisposable
@inject PersistentComponentState ApplicationState
@inject NavigationManager navigationManager

@attribute [Authorize]

<style>
    .mud-nav-menu {
        position: relative;
        z-index: 1500 !important;
    }

    /* S'assurer que les éléments dépliés restent aussi au-dessus */
    .mud-nav-group.mud-nav-group-expanded {
        position: relative;
        z-index: 1500;
    }

    /* Style pour le menu déplié */
    .mud-nav-group-items {
        position: relative;
        z-index: 1500;
    }
</style>

<MudNavMenu Rounded="true" Margin="Margin.Dense" Color="Color.Primary" Class="pa-2 mud-nav-menu">
    @if (isLoading)
    {
        <MudSkeleton Class="mb-4" Height="48px" />

        <!-- Admin Section Skeleton -->
        <div class="mb-4">
            <MudSkeleton Height="48px" />
            <div style="margin-left: 24px">
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
            </div>
        </div>

        <!-- Dashboard & Content Section Skeleton -->
        <MudSkeleton Height="48px" Class="mb-2" />
        <div class="mb-4">
            <MudSkeleton Height="48px" />
            <div style="margin-left: 24px">
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
            </div>
        </div>

        <!-- Users Section Skeleton -->
        <div class="mb-4">
            <MudSkeleton Height="48px" />
            <div style="margin-left: 24px">
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
            </div>
        </div>

        <!-- Account Section Skeleton -->
        <div class="mb-4">
            <MudSkeleton Height="48px" />
            <div style="margin-left: 24px">
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
            </div>
        </div>

        <!-- Settings Section Skeleton -->
        <div class="mb-4">
            <MudSkeleton Height="48px" />
            <div style="margin-left: 24px">
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
                <MudSkeleton Height="40px" Class="my-1" />
            </div>
        </div>

        <!-- Logout Skeleton -->
        <MudSkeleton Height="48px" />
    }
    else
    {
        <AuthorizeRoleView Roles="Admin">
            <Authorized>
                <MudNavGroup IconColor="Color.Secondary" Icon="@Icons.Material.Filled.Key" 
                Title="Licences" Expanded="false">
                <MudNavLink  Icon="@Icons.Material.Filled.Key" Href="users" Match="NavLinkMatch.Prefix">Gestion des licences</MudNavLink>
                <MudNavLink  Icon="@Icons.Material.Filled.AttachMoney" Href="/security" Match="NavLinkMatch.Prefix">Gestion des abonnements</MudNavLink>
                </MudNavGroup>
                <MudNavLink IconColor="Color.Secondary" Icon="@Icons.Material.Filled.SupervisedUserCircle" Href="/customers" Match="NavLinkMatch.Prefix">Clients</MudNavLink>
            </Authorized>
        </AuthorizeRoleView>
        <AuthorizeRoleView Roles="Admin, Manager">
            <Authorized>
                <MudNavLink IconColor="Color.Secondary" Icon="@Icons.Material.Filled.SpaceDashboard" Href="/" Match="NavLinkMatch.All">
                Dashboards
            </MudNavLink>
                <MudNavGroup IconColor="Color.Secondary" Icon="@Icons.Material.Filled.Create" Title="Création de contenu" Expanded="false">
                <MudNavLink Icon="@Icons.Material.Filled.Games" Href="/games" Match="NavLinkMatch.Prefix">Jeux</MudNavLink>
                <MudNavLink Icon="@Icons.Material.Filled.ModelTraining" Href="/trainings" Match="NavLinkMatch.Prefix">Formation</MudNavLink>
                </MudNavGroup>
            <MudNavGroup IconColor="Color.Secondary" Icon="@Icons.Material.Filled.Groups" Title="Utilisateurs" Expanded="false">
                    <MudNavLink Icon="@Icons.Material.Filled.Group" Href="users" Match="NavLinkMatch.Prefix">Utilisateurs</MudNavLink>
                    <MudNavLink Icon="@Icons.Material.Filled.GroupWork" Href="groups" Match="NavLinkMatch.Prefix">Groupes</MudNavLink>
                      <AuthorizeRoleView Roles="Admin">
            <Authorized>
                    <MudNavLink Icon="@Icons.Material.Filled.TypeSpecimen" Href="roles" Match="NavLinkMatch.Prefix">Rôles</MudNavLink>
                    </Authorized>
                    </AuthorizeRoleView>
                </MudNavGroup>
                <MudNavGroup IconColor="Color.Secondary" Icon="@Icons.Material.Filled.ManageAccounts" Title="Mon compte" Expanded="false">
                    <MudNavLink Icon="@Icons.Material.Filled.CreditScore" Href="users" Match="NavLinkMatch.Prefix">Mes abonnements</MudNavLink>
                    <MudNavLink Icon="@Icons.Material.Filled.TextSnippet" Href="/security" Match="NavLinkMatch.Prefix">Mes factures</MudNavLink>
                    <MudNavLink Icon="@Icons.Material.Filled.ShortText" Href="/security" Match="NavLinkMatch.Prefix">Information de facturation</MudNavLink>
                </MudNavGroup>
                <MudNavGroup IconColor="Color.Secondary" Icon="@Icons.Material.Filled.Settings" Title="Paramètre" Expanded="false">
                    <MudNavLink Icon="@Icons.Material.Filled.SettingsBrightness" Href="/users" Match="NavLinkMatch.Prefix">Thèmes</MudNavLink>
                    <MudNavLink Icon="@Icons.Material.Filled.DisplaySettings" Href="/security" Match="NavLinkMatch.Prefix">Difficulté</MudNavLink>
                    <MudNavLink Icon="@Icons.Material.Filled.Category" Href="/security" Match="NavLinkMatch.Prefix">Catégorie de tutoriel</MudNavLink>
                </MudNavGroup>
                <form action="Account/Logout" method="post">
                    <AntiforgeryToken />
                    <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                    <button type="submit" class="mud-nav-link mud-ripple">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Color="Color.Info" Class="mr-3"></MudIcon> Logout
                    </button>
                </form>
            </Authorized>
            </AuthorizeRoleView>
    }
</MudNavMenu>


@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    private string? currentUrl;
    private AuthenticationState authenticationState { get; set; }
    private ClaimsPrincipal user { get; set; }
    private bool isLoading = true;
    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            if (authenticationStateTask is not null)
            {
                authenticationState = await authenticationStateTask;
                if (user is null)
                    user = authenticationState?.User;
            }
            currentUrl = navigationManager.ToBaseRelativePath(navigationManager.Uri);
            navigationManager.LocationChanged += OnLocationChanged;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = navigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        navigationManager.LocationChanged -= OnLocationChanged;
    }
    
}


