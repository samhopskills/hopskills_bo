@page "/groups"

@inject IViewTeamListUseCase ViewTeamListUseCase
@inject IDialogService DialogService
@inject HttpClient Http
@inject Microsoft.Extensions.Configuration.IConfiguration config;


    <MudContainer Fixed="true">
    <MudDataGrid Loading="@isLoading" T="GroupViewModel" Items="@Teams"
                     MultiSelection="true"
                     Virtualize="true"
                     SortMode="SortMode.Multiple"
                     Filterable="true" ReadOnly="false"
                     StartedEditingItem="@StartedEditingItem"
                     CommittedItemChanges="@CommittedItemChanges"
                     EditMode="@(DataGridEditMode.Form)"
                     CanceledEditingItem="@CanceledEditingItem"
                     QuickFilter="@_quickFilter"
                     RowClick="@RowClicked"
                     RowContextMenuClick="RowRightClicked"
                     SelectedItemsChanged="@SelectedItemsChanged">
            <ToolBarContent>
                <MudGrid Spacing="10">
                    <MudItem>
                        <MudButton Size="@Size.Small"
                                   Variant="@Variant.Filled"
                               EndIcon="@Icons.Material.Filled.GroupAdd"
                                   Color="@Color.Primary" @onclick="OpenDialogAsync">Add</MudButton>
                    </MudItem>
                    <MudItem>
                        <MudButton Size="@Size.Small"
                                   Variant="@Variant.Filled"
                               EndIcon="@Icons.Material.Filled.GroupRemove"
                                   Color="@Color.Error" Disabled="@disabledDelete"
                                   OnClick="@((e) => DeleteServerAsync())">Delete</MudButton>
                    </MudItem>
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Placeholder="Search"
                                  Adornment="Adornment.Start" Immediate="true"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium" Class="mt-10"></MudTextField>
                </MudGrid>
            </ToolBarContent>
            <Columns>
                <SelectColumn T="Team" />
                <PropertyColumn Property="x => x.Name" Title="Name" />
                <PropertyColumn Property="x => x.CompanyId" Title="Company"/>
                <PropertyColumn Property="x => x.CreatedOn" Title="Creation Date"/>
                <TemplateColumn Filterable="false">
                    <CellTemplate>
                        <MudStack Row>
                            @* <MudIconButton Icon="@Icons.Material.Outlined.SupervisedUserCircle"
                                           Size="@Size.Small" Variant="@Variant.Text" 
                                           Color="@Color.Primary" /> *@
                            <MudIconButton Icon="@Icons.Material.Outlined.Edit"
                                       OnClick="@context.Actions.StartEditingItemAsync"
                                           Size="@Size.Small" Variant="@Variant.Text" 
                                           Color="@Color.Primary" />
                        </MudStack>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="Team" />
            </PagerContent>
        </MudDataGrid>
    </MudContainer>


@code {
    private List<GroupViewModel>? Teams = new List<GroupViewModel>();
    private bool disabledDelete;
    private string _searchString;
    private List<GroupViewModel> selectedTeams = new List<GroupViewModel>();
    private string? serviceEndpoint;
    bool isLoading = true;
    // quick filter - filter globally across multiple columns with the same input
    private Func<GroupViewModel, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (x.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    };

    protected override async Task OnInitializedAsync()
    {
        disabledDelete = true;
        var backendUrl = config.GetValue<string>("BackendUrl");
        serviceEndpoint = $"{backendUrl}/api/Groups/GetAll";
        if (!string.IsNullOrEmpty(serviceEndpoint))
        {
            Teams = await Http.GetFromJsonAsync<List<GroupViewModel>>(serviceEndpoint);
        }
        isLoading = false;
    }

    private List<string> _events = new();
    void StartedEditingItem(GroupViewModel item)
    {
    }

    void CanceledEditingItem(GroupViewModel item)
    {
        _events.Insert(0, $"Event = CanceledEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
    }

    async void CommittedItemChanges(GroupViewModel item)
    {
        _events.Insert(0, $"Event = CommittedItemChanges, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
        await OnInitializedAsync();
    }

    void RowClicked(DataGridRowClickEventArgs<GroupViewModel> args)
    {
        _events.Insert(0, $"Event = RowClick, Index = {args.RowIndex}, Data = {System.Text.Json.JsonSerializer.Serialize(args.Item)}");
    }

    void RowRightClicked(DataGridRowClickEventArgs<GroupViewModel> args)
    {
        _events.Insert(0, $"Event = RowRightClick, Index = {args.RowIndex}, Data = {System.Text.Json.JsonSerializer.Serialize(args.Item)}");
    }

    void SelectedItemsChanged(HashSet<GroupViewModel> items)
    {
        selectedTeams = items.ToList();
        disabledDelete = !(selectedTeams.Count > 0);
        _events.Insert(0, $"Event = SelectedItemsChanged, Data = {System.Text.Json.JsonSerializer.Serialize(items)}");
    }

    private async Task OpenDialogAsync()
    {
        var options = new DialogOptions { BackgroundClass = "my-custom-class" };

        var dialog = await DialogService.ShowAsync<AddGroupComponent>("Create a new team", options);

        var result = await dialog.Result;

        if (!result.Canceled)
            await OnInitializedAsync();

    }

    private async Task DeleteServerAsync()
    {
        var options = new DialogOptions { BackgroundClass = "my-custom-class" };

        var parameters = new DialogParameters<Dialog> {
            { x => x.ContentText, "Do you really want to delete these records? This process cannot be undone." },
            { x => x.ButtonText, "Delete" },
            { x => x.Color, Color.Error }
        };

        var dialog = await DialogService.ShowAsync<Dialog>("Delete records", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            // await ViewTeamListUseCase.DeleteAsync(selectedTeams);
            await OnInitializedAsync();
        }

    }
}

