@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions
<MudGrid>
    <MudItem xs="12" sm="12" md="12">
            <EditForm  Model="@questionFormInput" OnValidSubmit="OnValidSubmit">
                <DataAnnotationsValidator/>
                <MudCard>
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12">
                        <MudTextField T="string" Label="Question" 
                            @bind-Value="@questionFormInput.Question"
                            Required="true" Variant="Variant.Outlined"
                                      UserAttributes="@(new() { { "aria-required", "true" } } )"
                                      For="@(() => questionFormInput.Question)" 
                                      InputMode="InputMode.text" AutoGrow="true" Lines="5" />

                    </MudItem>
                        </MudGrid>
                        <br/>
                        <br/>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudTimePicker Label="Duration" Required="true" 
                            @bind-Time="@questionFormInput.Duration"
                                        TimeEditMode="TimeEditMode.OnlyMinutes"
                                       UserAttributes="@(new() { { "aria-required", "true" } } )"
                                       For="@(() => questionFormInput.Duration)" />
                    </MudItem>
                            <MudItem xs="12" sm="6" md="4">
                            </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField T="int"  Label="Xp" Required="true"
                            @bind-Value="@questionFormInput.Xperience"
                                      UserAttributes="@(new() { { "aria-required", "true" } } )"
                                      For="@(() => questionFormInput.Xperience)" />
                    </MudItem>
                </MudGrid>
                <br />
                    <MudGrid>
                    <MudItem xs="4" sm="4" md="4">
                        <MudFileUpload T="IBrowserFile" Accept=".png" FilesChanged="UploadFiles">
                            <ActivatorContent>
                                <MudFab Color="Color.Secondary"
                                        StartIcon="@Icons.Material.Filled.Image"
                                        Label="Load picture" />
                                    @if (base64Images.Any())
                                    {
                                        @foreach (var file in base64Images)
                                        {
                                            <MudItem>
                                                <MudImage Src="@file"
                                                          Style="height:100px;width:100px;" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete" />
                                            </MudItem>
                                        }
                                    }
                            </ActivatorContent>
                        </MudFileUpload>
                    </MudItem>
                    <MudItem xs="4" sm="4" md="4"></MudItem>
                    <MudItem xs="4" sm="4" md="4">
                        <MudFileUpload T="IBrowserFile" 
                            Accept=".mp3" FilesChanged="UploadFiles2" MaximumFileCount="100">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Filled"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.AudioFile">
                                    Upload audio files (mp3)
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                            @if (base64Audios.Any())
                            {
                                @foreach (var file in base64Audios)
                                {
                                    @if (!string.IsNullOrEmpty(file))
                                    {
                                        <MudItem>
                                            <audio controls src="@file" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete" />
                                            </MudItem>
                                    }
                                }
                            }
                    </MudItem>
                    </MudGrid>
                    <br />
                    <br />
                @foreach (var item in questionFormInput.PossibleAnswers)
                    {
                        <MudGrid>
                        <MudItem xs="9" sm="9" md="9">
                            <MudTextField InputMode="InputMode.text"
                                          Required="true"
                                          T="string" Label="@item.Label" 
                                          @bind-Value="@item.Answer"
                                          UserAttributes="@(new() { { "aria-required", "true" } } )"
                                          For="@(() => item.Label)"
                                          AutoGrow="true" Variant="Variant.Text" />
                        </MudItem>
                        <MudItem>
                            <MudCheckBox @bind-Value="@item.IsCorrect" T="bool"></MudCheckBox>
                        </MudItem>
                        @if(!item.Label.Equals("Answer 1"))
                        {
                            <MudItem>
                                <MudIconButton 
                                    OnClick="@(e => DeleteAnswer(item.Id-1))" 
                                    Icon="@Icons.Material.Rounded.Delete"></MudIconButton>
                            </MudItem>
                        }
                        </MudGrid>
                        <br />
                    }
                    <MudGrid>
                    <MudItem xs="4" sm="4" md="4">
                        <MudButton ButtonType="ButtonType.Button" 
                        EndIcon="@Icons.Material.Filled.Add" 
                        OnClick="AddAnswer">Add an answer</MudButton>
                        </MudItem>
                    </MudGrid>
                <br />
                <MudGrid>
                    <MudItem xs="12" sm="12" md="12">
                        <MudTextField InputMode="InputMode.text"
                                      T="string" 
                                      Label="Explain the correct answer" 
                                      Required="true"
                                      @bind-Value="questionFormInput.CorrectAnswerExplanation"
                                      UserAttributes="@(new() { { "aria-required", "true" } } )"
                                      For="@(() => questionFormInput.CorrectAnswerExplanation)"
                                      AutoGrow="true" Variant="Variant.Filled" />
                    </MudItem>
                </MudGrid>
                    </MudCardContent>
                </MudCard>
                <br />
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary" OnClick="OnValidSubmit"
                               DropShadow="false">Validate</MudButton>
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled" DropShadow="false" 
                               OnClick="Cancel">Cancel</MudButton>
                </MudCardActions>
                       </EditForm>
    </MudItem>
</MudGrid>

@code {
    int spacing;
    IList<IBrowserFile> _files = new List<IBrowserFile>();
    IList<IBrowserFile> _audios = new List<IBrowserFile>();
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }
    [Parameter]
    public EventCallback<int> OnCancelEvent { get; set; }
    [Parameter]
    public EventCallback<CreateMultipleQuestionsViewModel> OnValidEvent { get; set; }
    [Parameter]
    public CreateMultipleQuestionsViewModel questionFormInput { get; set; }
    private CustomerViewModel CompanySelected { get; set; }
    public bool Dense_CheckBox { get; set; }
    private bool fileNameWrong { get; set; }
    private bool audioFileNameWrong { get; set; }
    private bool formDisabled { get; set; }
    private List<string> base64Images = new();
    private List<string> base64Audios = new();
    private async void Cancel()
    {
        await OnCancelEvent.InvokeAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        // fileNameWrong = false;
        // audioFileNameWrong = false;
        // formDisabled = true;
        questionFormInput = new CreateMultipleQuestionsViewModel
            {
                PossibleAnswers = new List<CreateAnswerViewModel>
                {
                    new CreateAnswerViewModel { Id = 1, Label = "Answer 1",Answer = string.Empty,
                    IsCorrect = false}
                },
                ImageFiles = new List<string>(),
                AudioFiles = new List<string>()
            };
    }

    void Closed(MudChip<MudImage> chip)
    {
        // react to chip closed
    }

    private void AddAnswer()
    {
        questionFormInput.PossibleAnswers.Add(new CreateAnswerViewModel
        {
                Id = questionFormInput.PossibleAnswers.Count + 1,
                Label = $"Answer {questionFormInput.PossibleAnswers.Count + 1}",
            Answer = string.Empty,
            IsCorrect = false
        });
    }

    private EventCallback CorrectAnswer(int Id)
    {
        questionFormInput.PossibleAnswers[Id].IsCorrect = true;
        return EventCallback.Empty;
    }

    private EventCallback DeleteAnswer(int Id)
    {
        questionFormInput.PossibleAnswers.RemoveAt(Id);
        return EventCallback.Empty;
    }


    private async void UploadFiles(IBrowserFile file)
    {
        _files.Add(file);
        var format = "image/png";
        var resizeImage = await file.RequestImageFileAsync(format, 640, 480);
        var buffer = new byte[resizeImage.Size];
        await resizeImage.OpenReadStream().ReadAsync(buffer);
        base64Images.Add("data:image/png;base64," + Convert.ToBase64String(buffer));
        questionFormInput.ImageFiles.Add("data:image/png;base64," + Convert.ToBase64String(buffer));
        StateHasChanged();
    }

    private async void UploadFiles2(IBrowserFile file)
    {
        
        _audios.Add(file);
        using (var stream = file.OpenReadStream())
        {
            var length = stream.Length;
            if (length <= int.MaxValue)
            {
                var result = new byte[length];
                await stream.ReadAsync(result);
                base64Audios.Add("data:audio/mp3;base64," + Convert.ToBase64String(result));
                questionFormInput.AudioFiles.Add("data:audio/mp3;base64," + Convert.ToBase64String(result));
                StateHasChanged();
            }
        }
    }

    private async void OnValidSubmit()
    {
        await OnValidEvent.InvokeAsync(questionFormInput);
    }

    
}
